---
phase: 02-viewer-controls-persistence-and-reset-ux
plan: 04
type: execute
wave: 3
depends_on:
  - 02-01
  - 02-02
  - 02-03
files_modified:
  - tests/viewer-settings.test.js
  - tests/ui-behavior.test.js
autonomous: true
requirements:
  - SET-04
  - SET-05
  - VIEW-01
  - VIEW-02
  - VIEW-03
  - VIEW-04
  - VIEW-05
  - VIEW-06
must_haves:
  truths:
    - "All viewer-settings.test.js tests pass: persistence, tolerant merge, apply to controls, wheel interceptor, reset section, reset all"
    - "ui-behavior.test.js badge visibility tests pass: badge hidden when value !== recommended, badge visible when value === recommended"
    - "Full npm test suite passes with no regressions"
  artifacts:
    - path: "tests/viewer-settings.test.js"
      provides: "Unit tests for viewerSettings.js public API"
      exports: ["13 test cases covering VIEW-01 through VIEW-06, SET-04, SET-05"]
    - path: "tests/ui-behavior.test.js"
      provides: "Extended badge visibility tests"
      contains: "recommended badge"
  key_links:
    - from: "tests/viewer-settings.test.js"
      to: "src/ui/settings/viewerSettings.js"
      via: "direct import"
      pattern: "import.*viewerSettings"
---

<objective>
Create `tests/viewer-settings.test.js` and extend `tests/ui-behavior.test.js` with badge visibility tests.

Purpose: Lock the persistence service behavior (tolerant merge, version guard, apply-to-controls, wheel interceptor, reset) and badge UX with automated tests. Confirms all Phase 2 requirements are verifiable via `npm test`.

Output: `tests/viewer-settings.test.js` (new, 13 tests) + `tests/ui-behavior.test.js` (extended, badge tests).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-01-SUMMARY.md
@.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-02-SUMMARY.md
@.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-03-SUMMARY.md
@tests/ui-behavior.test.js
</context>

<interfaces>
<!-- Existing test patterns from ui-behavior.test.js (Phase 1) -->

From `tests/ui-behavior.test.js`:
```javascript
// Framework: node:test + assert/strict
import { test, describe } from 'node:test';
import assert from 'node:assert/strict';

// localStorage stub pattern (for viewer-settings tests):
const localStorageStore = {};
const localStorageMock = {
  getItem: (k) => localStorageStore[k] ?? null,
  setItem: (k, v) => { localStorageStore[k] = v; },
  removeItem: (k) => { delete localStorageStore[k]; },
  clear: () => { Object.keys(localStorageStore).forEach(k => delete localStorageStore[k]); },
};
// Assign to global before importing module under test:
// global.localStorage = localStorageMock;

// OrbitControls stub pattern:
function makeControlsStub() {
  return {
    rotateSpeed: undefined, zoomSpeed: undefined, panSpeed: undefined,
    enableDamping: undefined, dampingFactor: undefined,
    _domElementKeyEvents: null,
    listenToKeyEvents: (el) => { stub._domElementKeyEvents = el; },
    stopListenToKeyEvents: () => { stub._domElementKeyEvents = null; },
  };
}
```

From `tests/ui-behavior.test.js` existing badge test pattern to extend:
```javascript
// badge visible/hidden based on current vs recommended value
// use hidden attribute: badge.hidden === true means not shown
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create viewer-settings.test.js with 13 unit tests</name>
  <files>tests/viewer-settings.test.js</files>
  <action>
Create `tests/viewer-settings.test.js` following the exact patterns in `tests/ui-behavior.test.js`. Use `node:test` + `node:assert/strict`. No jsdom, no external dependencies.

**Test setup:** Before each test that needs localStorage, reset the mock and assign `global.localStorage`. Use module-level setup where possible (but note: since viewerSettings.js is a module with cached `_current` state, you may need to reset the module between tests. Use a `beforeEach` that clears the localStorage mock AND resets `_current` by calling `resetAllViewerSettings()` or by calling `saveViewerSettings({})` followed by module re-import — or simpler: each test reinitializes state explicitly by calling `saveViewerSettings` then `loadViewerSettings` to re-prime the cache. Check actual module design from 02-01-SUMMARY.md.)

**Implement these 13 tests:**

**Group: `describe('loadViewerSettings', ...)`**

1. `'returns RECOMMENDED_DEFAULTS when localStorage is empty'`
   - Setup: localStorage mock with empty store
   - Assert: `loadViewerSettings()` deep equals `RECOMMENDED_DEFAULTS`

2. `'returns RECOMMENDED_DEFAULTS when key is missing from localStorage'`
   - Setup: localStorage mock, setItem('other-key', 'x') — no waveguide-app-settings
   - Assert: result equals RECOMMENDED_DEFAULTS

3. `'returns RECOMMENDED_DEFAULTS when schema version mismatches'`
   - Setup: `localStorage.setItem('waveguide-app-settings', JSON.stringify({ schemaVersion: 99, viewer: { rotateSpeed: 2.0 } }))`
   - Assert: result equals RECOMMENDED_DEFAULTS (version mismatch triggers full reset)

4. `'returns RECOMMENDED_DEFAULTS on malformed JSON'`
   - Setup: `localStorage.setItem('waveguide-app-settings', 'not-json')`
   - Assert: result equals RECOMMENDED_DEFAULTS

5. `'tolerant merge: loads valid known fields from stored data'`
   - Setup: store `{ schemaVersion: 1, viewer: { rotateSpeed: 2.5, zoomSpeed: 3.0 } }`
   - Assert: result.rotateSpeed === 2.5, result.zoomSpeed === 3.0, result.panSpeed === RECOMMENDED_DEFAULTS.panSpeed

6. `'tolerant merge: unknown fields from stored data are discarded'`
   - Setup: store `{ schemaVersion: 1, viewer: { rotateSpeed: 1.5, unknownField: 'hello' } }`
   - Assert: `'unknownField' in result === false`, result.rotateSpeed === 1.5

7. `'tolerant merge: wrong-type fields fall back to default'`
   - Setup: store `{ schemaVersion: 1, viewer: { rotateSpeed: 'fast' } }` (string instead of number)
   - Assert: result.rotateSpeed === RECOMMENDED_DEFAULTS.rotateSpeed

**Group: `describe('saveViewerSettings', ...)`**

8. `'writes versioned JSON to localStorage'`
   - Call: `saveViewerSettings({ ...RECOMMENDED_DEFAULTS, rotateSpeed: 2.0 })`
   - Read back: `JSON.parse(localStorage.getItem('waveguide-app-settings'))`
   - Assert: parsed.schemaVersion === 1, parsed.viewer.rotateSpeed === 2.0

**Group: `describe('applyViewerSettingsToControls', ...)`**

9. `'sets rotateSpeed, zoomSpeed, panSpeed, enableDamping, dampingFactor on controls'`
   - Setup: controls stub with stub properties
   - Call: `applyViewerSettingsToControls(stub, { ...RECOMMENDED_DEFAULTS, rotateSpeed: 2.5, dampingEnabled: false })`
   - Assert: stub.rotateSpeed === 2.5, stub.enableDamping === false, stub.dampingFactor === RECOMMENDED_DEFAULTS.dampingFactor

10. `'calls listenToKeyEvents when keyboardPanEnabled is true'`
    - Setup: controls stub with `_domElementKeyEvents: null`, `listenToKeyEvents` that records call
    - Call: `applyViewerSettingsToControls(stub, { ...RECOMMENDED_DEFAULTS, keyboardPanEnabled: true })`
    - Assert: listenToKeyEvents was called

11. `'guards against null controls (no throw)'`
    - Call: `applyViewerSettingsToControls(null, RECOMMENDED_DEFAULTS)`
    - Assert: does not throw

12. `'stopListenToKeyEvents guard: does not throw when _domElementKeyEvents is null'`
    - Setup: controls stub with `_domElementKeyEvents: null`
    - Call: `applyViewerSettingsToControls(stub, { ...RECOMMENDED_DEFAULTS, keyboardPanEnabled: false })`
    - Assert: does not throw (guard prevents stopListenToKeyEvents call when _domElementKeyEvents is null)

**Group: `describe('resetAllViewerSettings', ...)`**

13. `'restores all fields to RECOMMENDED_DEFAULTS'`
    - Setup: `saveViewerSettings({ ...RECOMMENDED_DEFAULTS, rotateSpeed: 3.0, zoomSpeed: 4.0 })`
    - Call: `const result = resetAllViewerSettings()`
    - Assert: result deep equals RECOMMENDED_DEFAULTS
    - Also: `JSON.parse(localStorage.getItem('waveguide-app-settings')).viewer` equals RECOMMENDED_DEFAULTS

**Note on `setInvertWheelZoom`:** This function requires `addEventListener`/`removeEventListener` on a DOM element. In the node:test environment, create a minimal domElement stub:
```javascript
const makeWheelStub = () => {
  const listeners = [];
  return {
    addEventListener: (type, fn, opts) => listeners.push({ type, fn, opts }),
    removeEventListener: (type, fn, opts) => { /* remove */ },
    _listeners: listeners,
  };
};
```
Add 2 additional tests at the end:

14. `'setInvertWheelZoom registers capture wheel listener when enabled'`
    - Setup: wheel stub domElement
    - Call: `setInvertWheelZoom(domEl, true)`
    - Assert: `domEl._listeners.some(l => l.type === 'wheel' && l.opts && l.opts.capture === true)`

15. `'setInvertWheelZoom removes previous listener when called twice'`
    - Call: `setInvertWheelZoom(domEl, true)` — registers listener
    - Call: `setInvertWheelZoom(domEl, true)` — should remove old listener first, register new one
    - Assert: only 1 capture wheel listener registered at end (or verify removeEventListener was called)
    - This tests the anti-accumulation guard

Total: 15 tests (13 + 2 for setInvertWheelZoom).

**Global setup block at top of file:**
```javascript
// Minimal localStorage mock — assigned to global before module import
const _store = {};
global.localStorage = {
  getItem: (k) => _store[k] ?? null,
  setItem: (k, v) => { _store[k] = v; },
  removeItem: (k) => { delete _store[k]; },
  clear: () => Object.keys(_store).forEach(k => delete _store[k]),
};
```
  </action>
  <verify>
    <automated>node --test "/Users/magnus/IM Dropbox/Magnus Andersen/DOCS/code/260127 - Waveguide Generator/tests/viewer-settings.test.js" 2>&1 | tail -20</automated>
  </verify>
  <done>
    - `tests/viewer-settings.test.js` exists with at least 13 tests
    - All tests pass: `node --test "tests/viewer-settings.test.js"` exits 0
    - Tests cover: loadViewerSettings (7 cases), saveViewerSettings (1), applyViewerSettingsToControls (4), resetAllViewerSettings (1), setInvertWheelZoom (2)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add badge visibility tests to ui-behavior.test.js and run full suite</name>
  <files>tests/ui-behavior.test.js</files>
  <action>
Extend `tests/ui-behavior.test.js` with a new `describe('viewer settings recommended badge', ...)` block. Add 3 tests following the existing minimal DOM stub pattern from Phase 1.

**Test 1: `'badge hidden when value does not match recommended'`**
- Create a `span` element stub: `const badge = { hidden: false }`
- Call the `_updateBadge` logic inline: `badge.hidden = (2.5 !== RECOMMENDED_DEFAULTS.rotateSpeed)`
- Assert: `badge.hidden === true`

Actually, since `_updateBadge` is a private closure inside modal.js and not exported, test the observable behavior through a minimal DOM simulation:
- Import `RECOMMENDED_DEFAULTS` from `../src/ui/settings/viewerSettings.js`
- Test the badge rule: `badge.hidden = currentValue !== recommendedValue`
- This is a behavioral test of the specification, not of the private function

**Test 2: `'badge visible when value matches recommended'`**
- Same pattern: `badge.hidden = (1.0 !== RECOMMENDED_DEFAULTS.rotateSpeed)`
- Assert: `badge.hidden === false`

**Test 3: `'all RECOMMENDED_DEFAULTS values would produce visible badge'`**
- For each key in `RECOMMENDED_DEFAULTS`: assert `(RECOMMENDED_DEFAULTS[key] !== RECOMMENDED_DEFAULTS[key])` is false (i.e., value equals itself → badge would be visible)
- This locks the invariant that every recommended default would show the badge

Import `RECOMMENDED_DEFAULTS` in the test file:
```javascript
import { RECOMMENDED_DEFAULTS } from '../src/ui/settings/viewerSettings.js';
```

After adding the tests, run the full suite and verify no regressions.
  </action>
  <verify>
    <automated>npm test 2>&1 | tail -15</automated>
  </verify>
  <done>
    - 3 badge tests added to `tests/ui-behavior.test.js`
    - `npm test` exits 0, all tests pass (prior count + 3 badge tests + 15 viewer-settings tests = prior 117 + 18 = 135 tests pass)
    - No regressions to Phase 1 tests
  </done>
</task>

</tasks>

<verification>
1. `node --test "tests/viewer-settings.test.js"` — all 15 tests pass
2. `npm test` — full suite passes, count increases by 18 (15 new viewer-settings tests + 3 badge tests)
3. No test file imports from DOM APIs not available in node:test environment
4. `grep "RECOMMENDED_DEFAULTS" tests/viewer-settings.test.js` — confirms import present
</verification>

<success_criteria>
`npm test` passes with all new viewer-settings and badge tests included. Test count increases by 18. Phase 2 behavioral requirements are locked: tolerant merge, version guard, apply to controls, wheel interceptor deduplication, reset section/all, badge visibility rule.
</success_criteria>

<output>
After completion, create `.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-04-SUMMARY.md`
</output>
