---
phase: 02-viewer-controls-persistence-and-reset-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/ui/settings/viewerSettings.js
autonomous: true
requirements:
  - VIEW-06
must_haves:
  truths:
    - "loadViewerSettings() returns RECOMMENDED_DEFAULTS when localStorage is empty"
    - "loadViewerSettings() performs tolerant merge: known fields loaded, unknown fields discarded, missing fields filled with defaults"
    - "loadViewerSettings() returns RECOMMENDED_DEFAULTS when schema version mismatches"
    - "saveViewerSettings() writes versioned JSON {schemaVersion:1, viewer:{...}} to localStorage key waveguide-app-settings"
    - "applyViewerSettingsToControls() sets all OrbitControls properties on a mock controls object"
    - "setInvertWheelZoom() registers a capture-phase wheel interceptor when enabled; removes it when called again"
  artifacts:
    - path: "src/ui/settings/viewerSettings.js"
      provides: "Settings persistence service: RECOMMENDED_DEFAULTS, loadViewerSettings, saveViewerSettings, applyViewerSettingsToControls, setInvertWheelZoom, getCurrentViewerSettings, resetViewerSection, resetAllViewerSettings"
      exports:
        - RECOMMENDED_DEFAULTS
        - loadViewerSettings
        - saveViewerSettings
        - applyViewerSettingsToControls
        - setInvertWheelZoom
        - getCurrentViewerSettings
        - resetViewerSection
        - resetAllViewerSettings
  key_links:
    - from: "src/ui/settings/viewerSettings.js"
      to: "localStorage"
      via: "loadViewerSettings/saveViewerSettings"
      pattern: "localStorage\\.getItem.*waveguide-app-settings"
    - from: "src/ui/settings/viewerSettings.js"
      to: "OrbitControls"
      via: "applyViewerSettingsToControls(controls, settings)"
      pattern: "controls\\.rotateSpeed"
---

<objective>
Create the viewer settings persistence service module (`src/ui/settings/viewerSettings.js`).

Purpose: Establish the single source of truth for viewer settings — schema, RECOMMENDED_DEFAULTS, localStorage read/write with tolerant merge, runtime apply to OrbitControls, wheel inversion interceptor, and reset helpers. Scene.js and modal.js will import from this module in subsequent plans.

Output: `src/ui/settings/viewerSettings.js` with full public API exported and ready for downstream consumers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key patterns from Phase 1
@.planning/phases/01-settings-modal-entry-system-migration/01-03-SUMMARY.md

# Source files that define existing patterns
@src/state.js
@src/ui/simulation/jobTracker.js
</context>

<interfaces>
<!-- Types and contracts this module must export (consumed by plans 02-02 and 02-03) -->

```javascript
// RECOMMENDED_DEFAULTS — all viewer settings with their recommended values
export const RECOMMENDED_DEFAULTS = {
  rotateSpeed: 1.0,
  zoomSpeed: 1.0,
  panSpeed: 1.0,
  dampingEnabled: true,
  dampingFactor: 0.05,
  invertWheelZoom: false,
  startupCameraMode: 'perspective',
  keyboardPanEnabled: false,   // matches current scene.js: listenToKeyEvents never called
};

// SETTINGS_KEY — consistent with future phases adding simBasic etc. under same key
const SETTINGS_KEY = 'waveguide-app-settings';
const SCHEMA_VERSION = 1;

// loadViewerSettings(): returns merged settings from localStorage, or RECOMMENDED_DEFAULTS
export function loadViewerSettings(): object

// saveViewerSettings(settings): writes { schemaVersion: 1, viewer: settings } to localStorage
export function saveViewerSettings(settings: object): void

// getCurrentViewerSettings(): returns the cached in-memory settings state
// (Used by toggleCamera in scene.js to re-apply settings after OrbitControls recreation)
export function getCurrentViewerSettings(): object

// applyViewerSettingsToControls(controls, settings): sets all OrbitControls properties
// controls must be an OrbitControls instance; call after new OrbitControls(...)
export function applyViewerSettingsToControls(controls: object, settings: object): void

// setInvertWheelZoom(domElement, invertEnabled): registers/removes capture-phase wheel interceptor
// Must be called after renderer.domElement exists; safe to call multiple times
export function setInvertWheelZoom(domElement: Element, invertEnabled: boolean): void

// resetViewerSection(sectionKey): resets one section's fields to RECOMMENDED_DEFAULTS
// sectionKey: 'orbit' | 'camera' | 'input'
// Returns the new full settings after reset
export function resetViewerSection(sectionKey: string): object

// resetAllViewerSettings(): resets all fields to RECOMMENDED_DEFAULTS
// Returns the new settings
export function resetAllViewerSettings(): object
```

From `src/state.js` (tolerant merge pattern to follow):
```javascript
// Guard localStorage access; try/catch JSON parse; field-by-field type check
if (typeof localStorage === 'undefined') return { ...DEFAULTS };
const raw = localStorage.getItem(KEY);
if (!raw) return { ...DEFAULTS };
const parsed = JSON.parse(raw);
// version check → fallback to defaults if mismatch
```

From `src/ui/simulation/jobTracker.js` (guard pattern):
```javascript
if (typeof localStorage === 'undefined') return;
try { localStorage.setItem(KEY, JSON.stringify(payload)); } catch {}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create viewerSettings.js persistence service</name>
  <files>src/ui/settings/viewerSettings.js</files>
  <action>
Create `src/ui/settings/viewerSettings.js` as a new ES module with the following complete implementation:

**RECOMMENDED_DEFAULTS (const, exported):**
```javascript
export const RECOMMENDED_DEFAULTS = {
  rotateSpeed: 1.0,
  zoomSpeed: 1.0,
  panSpeed: 1.0,
  dampingEnabled: true,
  dampingFactor: 0.05,
  invertWheelZoom: false,
  startupCameraMode: 'perspective',
  keyboardPanEnabled: false,
};
```

**SECTION_KEYS — maps sub-section key to its field names (for resetViewerSection):**
```javascript
const SECTION_KEYS = {
  orbit: ['rotateSpeed', 'zoomSpeed', 'panSpeed', 'dampingEnabled', 'dampingFactor'],
  camera: ['startupCameraMode'],
  input: ['invertWheelZoom', 'keyboardPanEnabled'],
};
```

**Module-level in-memory state** (private `_current`, initialized on first load):
- `_current` starts as `null`, lazily initialized by `loadViewerSettings()` and cached.

**loadViewerSettings():**
- Guard: `if (typeof localStorage === 'undefined') return { ...RECOMMENDED_DEFAULTS }`
- try/catch JSON.parse from `localStorage.getItem('waveguide-app-settings')`
- If null/parse error: return `{ ...RECOMMENDED_DEFAULTS }`
- If `parsed.schemaVersion !== 1`: return `{ ...RECOMMENDED_DEFAULTS }`
- Tolerant merge: start with `{ ...RECOMMENDED_DEFAULTS }`, loop over `Object.keys(RECOMMENDED_DEFAULTS)`, copy from `parsed.viewer` only if key exists AND `typeof stored[key] === typeof RECOMMENDED_DEFAULTS[key]`
- Cache result in `_current` and return it
- On any catch: return `{ ...RECOMMENDED_DEFAULTS }`

**saveViewerSettings(settings):**
- Guard: `if (typeof localStorage === 'undefined') return`
- `_current = settings` (update in-memory cache)
- try: `localStorage.setItem('waveguide-app-settings', JSON.stringify({ schemaVersion: 1, viewer: settings }))`
- catch silently (quota exceeded)

**getCurrentViewerSettings():**
- Returns `_current ?? loadViewerSettings()`

**_debouncedSave — module-level debounce (300ms):**
```javascript
let _saveTimer = null;
export function debouncedSaveViewerSettings(settings) {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => saveViewerSettings(settings), 300);
}
```

**applyViewerSettingsToControls(controls, settings):**
- Guard: `if (!controls) return`
- Set: `controls.rotateSpeed`, `controls.zoomSpeed`, `controls.panSpeed`, `controls.enableDamping`, `controls.dampingFactor`
- Keyboard pan: `if (settings.keyboardPanEnabled) { controls.listenToKeyEvents(window); } else if (controls._domElementKeyEvents) { controls.stopListenToKeyEvents(); }`
- NOTE: `invertWheelZoom` is NOT applied here — it is handled by `setInvertWheelZoom` separately

**setInvertWheelZoom(domElement, invertEnabled):**
- Module-level `let _wheelInterceptor = null`
- Always removeEventListener first if `_wheelInterceptor` is set (prevent accumulation)
- If `invertEnabled`: create new interceptor function: calls `e.stopImmediatePropagation()`, creates `new WheelEvent('wheel', { ...spread e properties, deltaY: -e.deltaY, bubbles: true, cancelable: e.cancelable })`, dispatches on `e.target`, stores reference in `_wheelInterceptor`, calls `domElement.addEventListener('wheel', _wheelInterceptor, { capture: true })`
- If not enabled: set `_wheelInterceptor = null`
- NOTE: WheelEvent constructor does not spread all event properties — pass explicitly: `deltaMode: e.deltaMode, deltaX: e.deltaX, deltaZ: e.deltaZ, ctrlKey: e.ctrlKey, shiftKey: e.shiftKey, altKey: e.altKey, metaKey: e.metaKey, bubbles: e.bubbles, cancelable: e.cancelable, deltaY: -e.deltaY`

**resetViewerSection(sectionKey):**
- Get field names from `SECTION_KEYS[sectionKey]` (if unknown key, return current settings unchanged)
- Copy `_current ?? loadViewerSettings()` into a new object
- Override only the fields for the given section with values from `RECOMMENDED_DEFAULTS`
- Save the new settings (immediate, not debounced — reset is intentional)
- Return the new settings object

**resetAllViewerSettings():**
- New settings = `{ ...RECOMMENDED_DEFAULTS }`
- `saveViewerSettings(newSettings)` (immediate)
- Return the new settings
  </action>
  <verify>
    <automated>node --input-type=module --eval "
import { RECOMMENDED_DEFAULTS, loadViewerSettings, saveViewerSettings, getCurrentViewerSettings, applyViewerSettingsToControls, setInvertWheelZoom, resetViewerSection, resetAllViewerSettings, debouncedSaveViewerSettings } from '/Users/magnus/IM Dropbox/Magnus Andersen/DOCS/code/260127 - Waveguide Generator/src/ui/settings/viewerSettings.js';
console.log('EXPORTS OK:', typeof RECOMMENDED_DEFAULTS === 'object');
console.log('DEFAULTS rotateSpeed:', RECOMMENDED_DEFAULTS.rotateSpeed === 1.0);
console.log('SECTION KEYS present:', typeof resetViewerSection === 'function');
console.log('ALL EXPORTS:', [loadViewerSettings, saveViewerSettings, getCurrentViewerSettings, applyViewerSettingsToControls, setInvertWheelZoom, resetAllViewerSettings, debouncedSaveViewerSettings].every(f => typeof f === 'function'));
" 2>&1</automated>
  </verify>
  <done>
    - `src/ui/settings/viewerSettings.js` exists and exports: `RECOMMENDED_DEFAULTS`, `loadViewerSettings`, `saveViewerSettings`, `getCurrentViewerSettings`, `debouncedSaveViewerSettings`, `applyViewerSettingsToControls`, `setInvertWheelZoom`, `resetViewerSection`, `resetAllViewerSettings`
    - `loadViewerSettings()` returns `RECOMMENDED_DEFAULTS` spread when localStorage is empty (confirmed by import check)
    - `SECTION_KEYS` maps `orbit`, `camera`, `input` to correct field arrays
    - Module loads without error
  </done>
</task>

</tasks>

<verification>
1. Module imports without error: `node --input-type=module --eval "import { RECOMMENDED_DEFAULTS } from './src/ui/settings/viewerSettings.js'"`
2. All 9 exports present: `RECOMMENDED_DEFAULTS`, `loadViewerSettings`, `saveViewerSettings`, `getCurrentViewerSettings`, `debouncedSaveViewerSettings`, `applyViewerSettingsToControls`, `setInvertWheelZoom`, `resetViewerSection`, `resetAllViewerSettings`
3. `RECOMMENDED_DEFAULTS` has all 8 keys with correct types and values
4. No changes to other files — this plan only creates viewerSettings.js
</verification>

<success_criteria>
`src/ui/settings/viewerSettings.js` exists with complete public API. Downstream plans (02-02, 02-03) can import from it without modification. The module follows established project patterns: `typeof localStorage === 'undefined'` guard, try/catch JSON parse, field-by-field type-safe merge.
</success_criteria>

<output>
After completion, create `.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-01-SUMMARY.md`
</output>
