---
phase: 02-viewer-controls-persistence-and-reset-ux
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/app/scene.js
autonomous: true
requirements:
  - VIEW-01
  - VIEW-02
  - VIEW-03
  - VIEW-04
  - VIEW-05
must_haves:
  truths:
    - "App startup reads viewer settings and applies OrbitControls speeds, damping, and keyboard pan on first load"
    - "App startup respects startupCameraMode — perspective or orthographic camera is created based on persisted setting"
    - "Invert wheel zoom interceptor is registered on startup if invertWheelZoom is true in persisted settings"
    - "Camera toggle (toggleCamera) re-applies all viewer settings after creating new OrbitControls — speeds do not revert to Three.js defaults after toggle"
    - "Invert wheel zoom state is re-applied after camera toggle"
  artifacts:
    - path: "src/app/scene.js"
      provides: "Runtime viewer settings application at startup and after camera toggle"
      contains: "loadViewerSettings"
  key_links:
    - from: "src/app/scene.js setupScene()"
      to: "src/ui/settings/viewerSettings.js"
      via: "import { loadViewerSettings, applyViewerSettingsToControls, setInvertWheelZoom } from"
      pattern: "loadViewerSettings"
    - from: "src/app/scene.js toggleCamera()"
      to: "src/ui/settings/viewerSettings.js"
      via: "getCurrentViewerSettings() after new OrbitControls(...)"
      pattern: "getCurrentViewerSettings"
---

<objective>
Wire viewer settings into `src/app/scene.js` so that OrbitControls properties and startup camera mode are applied from persisted settings on every page load and after every camera toggle.

Purpose: Makes VIEW-01 through VIEW-05 actually take effect at runtime — without this wiring, the persistence service (02-01) exists but nothing reads it on startup.

Output: Modified `src/app/scene.js` with `loadViewerSettings` applied in `setupScene()` and `getCurrentViewerSettings` re-applied in `toggleCamera()`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-01-SUMMARY.md
@src/app/scene.js
</context>

<interfaces>
<!-- Contracts from viewerSettings.js (02-01 output) that scene.js must import -->

```javascript
// From src/ui/settings/viewerSettings.js:
import {
  loadViewerSettings,      // () => settings object — call once at startup
  applyViewerSettingsToControls,  // (controls, settings) => void
  setInvertWheelZoom,      // (domElement, bool) => void
  getCurrentViewerSettings // () => settings — returns cached in-memory state
} from '../ui/settings/viewerSettings.js';
```

**Current scene.js setupScene() flow (to modify):**
```javascript
export function setupScene(app) {
  app.scene = createScene();
  app.cameraMode = 'perspective';          // ← must read from settings
  // ...
  app.camera = createPerspectiveCamera(aspect);  // ← conditional on cameraMode
  // ...
  app.controls = new OrbitControls(app.camera, app.renderer.domElement);
  app.controls.enableDamping = true;       // ← replace with applyViewerSettingsToControls
  // ... animate(app); return true;
}
```

**Current scene.js toggleCamera() flow (to modify):**
```javascript
export function toggleCamera(app) {
  // ... creates new camera + new OrbitControls ...
  app.controls = new OrbitControls(app.camera, app.renderer.domElement);
  app.controls.target.copy(target);
  app.controls.enableDamping = true;    // ← replace with applyViewerSettingsToControls
  app.controls.update();
  oldControls.dispose();
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Apply viewer settings in setupScene and toggleCamera</name>
  <files>src/app/scene.js</files>
  <action>
Modify `src/app/scene.js` to read and apply viewer settings at startup and after camera toggle.

**Add import at the top of the file (alongside existing imports):**
```javascript
import {
  loadViewerSettings,
  applyViewerSettingsToControls,
  setInvertWheelZoom,
  getCurrentViewerSettings,
} from '../ui/settings/viewerSettings.js';
```

**In `setupScene(app)` — make these targeted changes:**

1. Call `loadViewerSettings()` at the top of the function and store the result:
   ```javascript
   const viewerSettings = loadViewerSettings();
   ```

2. Replace the hardcoded `app.cameraMode = 'perspective'` line with:
   ```javascript
   app.cameraMode = viewerSettings.startupCameraMode || 'perspective';
   ```

3. Make camera creation conditional based on `app.cameraMode`:
   ```javascript
   if (app.cameraMode === 'orthographic') {
     const size = getOrthoSize();
     app.camera = createOrthoCamera(aspect, size);
   } else {
     app.camera = createPerspectiveCamera(aspect);
   }
   ```
   (Currently only `createPerspectiveCamera` is called — add the conditional branch. The existing call to `createPerspectiveCamera(aspect)` becomes the else branch.)

4. After `app.controls = new OrbitControls(app.camera, app.renderer.domElement)`, replace `app.controls.enableDamping = true` with:
   ```javascript
   applyViewerSettingsToControls(app.controls, viewerSettings);
   setInvertWheelZoom(app.renderer.domElement, viewerSettings.invertWheelZoom);
   ```

**In `toggleCamera(app)` — make these targeted changes:**

1. After `app.controls = new OrbitControls(app.camera, app.renderer.domElement)`, replace `app.controls.enableDamping = true` with:
   ```javascript
   const vs = getCurrentViewerSettings();
   applyViewerSettingsToControls(app.controls, vs);
   setInvertWheelZoom(app.renderer.domElement, vs.invertWheelZoom);
   ```
   Keep `app.controls.target.copy(target)` and `app.controls.update()` calls unchanged.

**Do not change any other logic** in scene.js. The existing import of `getDisplayMode` from modal.js stays. The `onResize`, `renderModel`, `focusOnModel`, `zoom`, `animate`, `calculateCurvatureColors`, `getOrthoSize` functions are unchanged.

**Key concern — createOrthoCamera signature:** `toggleCamera` already calls `createOrthoCamera(aspect, size)`. Check that `setupScene` uses the same signature when `cameraMode === 'orthographic'`. If `createOrthoCamera` in `src/viewer/index.js` takes `(aspect, size)`, use `createOrthoCamera(aspect, getOrthoSize())`.
  </action>
  <verify>
    <automated>node --input-type=module --eval "
import { setupScene, toggleCamera } from '/Users/magnus/IM Dropbox/Magnus Andersen/DOCS/code/260127 - Waveguide Generator/src/app/scene.js';
console.log('setupScene is function:', typeof setupScene === 'function');
console.log('toggleCamera is function:', typeof toggleCamera === 'function');
" 2>&1 | head -20</automated>
  </verify>
  <done>
    - `src/app/scene.js` imports `loadViewerSettings`, `applyViewerSettingsToControls`, `setInvertWheelZoom`, `getCurrentViewerSettings` from `../ui/settings/viewerSettings.js`
    - `setupScene()` reads `loadViewerSettings()` and uses `startupCameraMode` to select perspective or orthographic camera
    - `setupScene()` calls `applyViewerSettingsToControls` and `setInvertWheelZoom` after creating OrbitControls (replaces hardcoded `enableDamping = true`)
    - `toggleCamera()` calls `getCurrentViewerSettings()` and re-applies all settings after creating new OrbitControls (replaces hardcoded `enableDamping = true`)
    - Module imports without error
  </done>
</task>

</tasks>

<verification>
1. Module import check passes (no syntax errors)
2. `grep "loadViewerSettings" src/app/scene.js` — appears in import and setupScene body
3. `grep "getCurrentViewerSettings" src/app/scene.js` — appears in toggleCamera body
4. `grep "enableDamping = true" src/app/scene.js` — should NOT appear (replaced by applyViewerSettingsToControls)
5. `npm test` still passes (no regressions to existing scene-related tests)
</verification>

<success_criteria>
`src/app/scene.js` applies viewer settings at every OrbitControls construction point. OrbitControls speeds, damping, keyboard pan, and wheel zoom direction are all driven by `viewerSettings.js` — nothing is hardcoded. `npm test` passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-02-SUMMARY.md`
</output>
