---
phase: 02-viewer-controls-persistence-and-reset-ux
plan: 03
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/ui/settings/modal.js
  - src/style.css
autonomous: true
requirements:
  - SET-04
  - SET-05
  - VIEW-01
  - VIEW-02
  - VIEW-03
  - VIEW-04
  - VIEW-05
must_haves:
  truths:
    - "Settings > Viewer section shows three sub-sections: Orbit Controls (speeds + damping), Camera (startup mode), Input (invert wheel, keyboard pan)"
    - "Each speed slider has a numeric readout that updates live as the slider moves"
    - "Recommended badge appears inline when a control value matches RECOMMENDED_DEFAULTS; disappears when value deviates"
    - "Damping factor slider row is hidden when damping is disabled; visible when damping is enabled"
    - "Each sub-section header has a Reset button that restores only that sub-section to recommended values and updates badges immediately"
    - "Settings > System section has a Reset All Settings action row (button + help text) that restores all viewer fields to recommended values AND live-applies them to OrbitControls immediately"
    - "All control changes save to localStorage via debouncedSaveViewerSettings and apply live to app.controls"
    - "Startup camera mode change saves to localStorage but does NOT toggle the live camera (note in UI: 'Takes effect on next launch')"
  artifacts:
    - path: "src/ui/settings/modal.js"
      provides: "Complete Viewer section UI with sub-sections, sliders, badges, reset buttons; System section reset-all action"
      contains: "viewerSettings"
    - path: "src/style.css"
      provides: "Sub-section header, badge pill, slider+readout, reset button styles"
      contains: "settings-subsection"
  key_links:
    - from: "src/ui/settings/modal.js _buildViewerSection()"
      to: "src/ui/settings/viewerSettings.js"
      via: "import { RECOMMENDED_DEFAULTS, getCurrentViewerSettings, debouncedSaveViewerSettings, applyViewerSettingsToControls, setInvertWheelZoom, resetViewerSection, resetAllViewerSettings }"
      pattern: "RECOMMENDED_DEFAULTS"
    - from: "src/ui/settings/modal.js _buildSystemSection()"
      to: "src/ui/settings/viewerSettings.js resetAllViewerSettings"
      via: "reset-all-settings-btn click handler"
      pattern: "resetAllViewerSettings"
---

<objective>
Build the Viewer sub-section UI controls inside the Settings modal and wire the System section reset-all action.

Purpose: Makes VIEW-01 through VIEW-05 visible and interactive in the Settings modal. Adds SET-04 (per-section reset) and SET-05 (reset all) UX. Every change auto-saves via debounced write and live-applies to OrbitControls where applicable.

Output: Modified `src/ui/settings/modal.js` with complete Viewer sub-sections (Orbit Controls, Camera, Input) + modified `src/style.css` with sub-section + badge + slider-readout + reset-button styles.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-01-SUMMARY.md
@src/ui/settings/modal.js
@src/style.css
</context>

<interfaces>
<!-- Contracts from viewerSettings.js (02-01) that modal.js must import -->

```javascript
import {
  RECOMMENDED_DEFAULTS,
  getCurrentViewerSettings,
  debouncedSaveViewerSettings,
  applyViewerSettingsToControls,
  setInvertWheelZoom,
  resetViewerSection,
  resetAllViewerSettings,
} from './viewerSettings.js';
```

<!-- Existing modal.js patterns to follow -->

From Phase 1 `_buildSystemSection()` — the settings-action-row pattern:
```javascript
const row = document.createElement('div');
row.className = 'settings-action-row';
const btn = document.createElement('button');
btn.type = 'button';
btn.id = 'check-updates-btn';
btn.className = 'secondary';
btn.textContent = 'Check for App Updates';
```

From Phase 1 CSS (already in style.css):
- `.settings-control-row` — inline row with label + value
- `.settings-control-value` — right-side value wrapper
- `.settings-action-row` — vertical stack action row
- `.settings-action-help` — muted help text below button
- `--accent-color`, `--text-secondary`, `--border-color`, `--input-bg`, `--text-muted`

The app object for live-apply: `window.app` is the global app object containing `app.controls` (OrbitControls) and `app.renderer.domElement`.
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add CSS for sub-section headers, badges, slider-readout rows, and reset buttons</name>
  <files>src/style.css</files>
  <action>
Append the following CSS rules to `src/style.css`, after the existing Settings Modal block (after line 1421). Add a clear comment block header.

```css
/* ======================================================
   Settings Modal — Viewer Sub-sections + Badges + Sliders
   ====================================================== */

/* Sub-section header: title on left, Reset button on right */
.settings-subsection-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 16px 0 6px 0;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--border-color);
}

.settings-subsection-header:first-child {
    margin-top: 4px;
}

.settings-subsection-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin: 0;
}

/* Reset button inside sub-section header */
.settings-reset-btn {
    font-size: 0.72rem;
    font-weight: 500;
    color: var(--text-secondary);
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 2px 8px;
    cursor: pointer;
    margin: 0;
    min-width: unset;
    width: auto;
    transition: color 0.15s, border-color 0.15s, background 0.15s;
    opacity: 0.75;
}

.settings-reset-btn:hover {
    color: var(--accent-color);
    border-color: var(--accent-color);
    background: transparent;
    opacity: 1;
}

/* Recommended badge — inline pill next to control value */
.settings-recommended-badge {
    display: inline-block;
    font-size: 0.65rem;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: 10px;
    background: var(--input-bg);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    margin-left: 6px;
    white-space: nowrap;
    vertical-align: middle;
    opacity: 0.85;
}

/* Slider + readout wrapper inside .settings-control-value */
.settings-slider-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.settings-slider-group input[type="range"] {
    width: 100px;
    accent-color: var(--accent-color);
    cursor: pointer;
    margin: 0;
}

.settings-slider-readout {
    font-size: 0.82rem;
    color: var(--text-color);
    min-width: 30px;
    text-align: right;
    font-variant-numeric: tabular-nums;
}

/* Reset all settings action row button — align-self: flex-start */
.settings-action-row button#reset-all-settings-btn {
    width: auto;
    align-self: flex-start;
}
```
  </action>
  <verify>
    <automated>node -e "const fs = require('fs'); const css = fs.readFileSync('/Users/magnus/IM Dropbox/Magnus Andersen/DOCS/code/260127 - Waveguide Generator/src/style.css', 'utf8'); console.log('subsection-header:', css.includes('settings-subsection-header')); console.log('badge:', css.includes('settings-recommended-badge')); console.log('slider-group:', css.includes('settings-slider-group')); console.log('reset-btn:', css.includes('settings-reset-btn'));"</automated>
  </verify>
  <done>
    - All 4 new CSS classes present in style.css: `.settings-subsection-header`, `.settings-recommended-badge`, `.settings-slider-group`, `.settings-reset-btn`
    - Appended after existing Settings Modal block, not inserted in the middle
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Viewer sub-sections in modal.js and wire System reset-all</name>
  <files>src/ui/settings/modal.js</files>
  <action>
Modify `src/ui/settings/modal.js` to import from viewerSettings.js and replace `_buildViewerSection()` with a full implementation. Also add reset-all to `_buildSystemSection()`.

**1. Add import at the top of modal.js (after existing content, at the module level):**
```javascript
import {
  RECOMMENDED_DEFAULTS,
  getCurrentViewerSettings,
  debouncedSaveViewerSettings,
  applyViewerSettingsToControls,
  setInvertWheelZoom,
  resetViewerSection,
  resetAllViewerSettings,
} from './viewerSettings.js';
```

**2. Replace `_buildViewerSection()` entirely** with a new implementation:

The new `_buildViewerSection()` builds three sub-sections:

**Sub-section "Orbit Controls"** (sectionKey: `'orbit'`):
- Sub-section header with title "Orbit Controls" + Reset button (`resetViewerSection('orbit')`)
- `rotateSpeed` slider row (min=0.1, max=5.0, step=0.1, label="Rotate Speed")
- `zoomSpeed` slider row (min=0.1, max=5.0, step=0.1, label="Zoom Speed")
- `panSpeed` slider row (min=0.1, max=5.0, step=0.1, label="Pan Speed")
- `dampingEnabled` toggle row (label="Enable Damping", checkbox)
- `dampingFactor` slider row (min=0.01, max=0.5, step=0.01, label="Damping Factor") — `hidden` when dampingEnabled is false

**Sub-section "Camera"** (sectionKey: `'camera'`):
- Sub-section header with title "Camera" + Reset button (`resetViewerSection('camera')`)
- `startupCameraMode` radio control row (label="Startup Camera Mode", two radios: value="perspective" label="Perspective", value="orthographic" label="Orthographic")
- Help note element after the row: `<p class="settings-section-help" style="margin-top:4px;font-style:italic;">Takes effect on next launch.</p>`

**Sub-section "Input"** (sectionKey: `'input'`):
- Sub-section header with title "Input" + Reset button (`resetViewerSection('input')`)
- `invertWheelZoom` toggle row (label="Invert Scroll Zoom", checkbox)
- `keyboardPanEnabled` toggle row (label="Keyboard Pan Shortcuts", checkbox)

**Helper functions to implement inside modal.js (private, not exported):**

`_buildSubSectionHeader(title, onReset)`:
- Creates `div.settings-subsection-header` with `h4.settings-subsection-title` (text=title) + `button.settings-reset-btn` (text="Reset", onclick=onReset)

`_buildSliderRow(labelText, settingKey, min, max, step, currentSettings)`:
- Creates `div.settings-control-row`
- Left: `label` with text + for pointing to a range input id
- Right: `div.settings-control-value` containing `div.settings-slider-group` with:
  - `input[type=range]` with id=`viewer-${settingKey}`, min, max, step, value=`currentSettings[settingKey]`
  - `span.settings-slider-readout` showing current value (e.g. `"1.0"` for rotateSpeed)
  - `span.settings-recommended-badge` with text "Recommended", hidden = `currentSettings[settingKey] !== RECOMMENDED_DEFAULTS[settingKey]`
- On `input` event: update readout text, update badge visibility, update `_viewerState[settingKey]`, call `debouncedSaveViewerSettings(_viewerState)`, call `_applyLive()`
- Returns `{ row, badge }` so the reset handler can update badges programmatically

`_buildToggleRow(labelText, settingKey, currentSettings)`:
- Creates `div.settings-control-row`
- Left: `label`
- Right: `div.settings-control-value` with checkbox `input[type=checkbox]` id=`viewer-${settingKey}`, checked=`currentSettings[settingKey]`, + `span.settings-recommended-badge` hidden when value !== recommended
- On `change` event: update `_viewerState[settingKey]`, save+apply
- Returns `{ row, badge }`

**Module-level state inside `_buildViewerSection()` scope:**

Use a closure-local `_viewerState` object initialized from `getCurrentViewerSettings()` at the start of `_buildViewerSection()`. This is separate from the modal `_state` object — do NOT modify the existing `_state` object.

**`_applyLive()` (closure inside `_buildViewerSection`):**
```javascript
function _applyLive() {
  const controls = window.app && window.app.controls;
  applyViewerSettingsToControls(controls, _viewerState);
  const domEl = window.app && window.app.renderer && window.app.renderer.domElement;
  if (domEl) setInvertWheelZoom(domEl, _viewerState.invertWheelZoom);
}
```

**Damping toggle special handling:**
After the dampingEnabled toggle's `change` event, show/hide the dampingFactor row:
```javascript
dampingToggle.addEventListener('change', (e) => {
  _viewerState.dampingEnabled = e.target.checked;
  dampingFactorRow.hidden = !e.target.checked;
  _updateBadge(dampingEnabledBadge, e.target.checked, RECOMMENDED_DEFAULTS.dampingEnabled);
  debouncedSaveViewerSettings(_viewerState);
  _applyLive();
});
```

**Per-section reset handler (example for orbit section):**
```javascript
function onResetOrbit() {
  const newSettings = resetViewerSection('orbit');
  _viewerState = { ..._viewerState, ...newSettings };
  // Update DOM: set slider.value, readout text, badge visibility for each orbit field
  // Update dampingFactor row visibility
  _applyLive();
}
```

**3. In `_buildSystemSection()` — append reset-all action row after the existing updateRow:**

Add a second `div.settings-action-row` containing:
- `button#reset-all-settings-btn.secondary` with text "Reset All Settings to Defaults"
- `p.settings-action-help` with text "Restores all viewer controls to their recommended default values. Takes effect immediately."

Wire the button click — IMPORTANT: after resetting storage, live-apply to OrbitControls immediately (locked decision: speeds/damping/wheel zoom direction apply in real time):
```javascript
resetAllBtn.addEventListener('click', () => {
  resetAllViewerSettings();
  applyViewerSettingsToControls(window.app?.controls, RECOMMENDED_DEFAULTS);
  const domEl = window.app?.renderer?.domElement;
  if (domEl) setInvertWheelZoom(domEl, RECOMMENDED_DEFAULTS.invertWheelZoom);
});
```

**Key constraints:**
- Do NOT remove existing Real-time Updates and Display Mode controls from the Viewer section — keep them where they are and add the new sub-sections AFTER them (or at top — your judgment, but keep existing controls)
- The existing `backdrop.addEventListener('change', ...)` handler for `live-update`, `display-mode`, `download-sim-mesh` must remain unchanged
- Do NOT use `innerHTML` for the slider/badge/radio groups — build with `document.createElement` following Phase 1 pattern (except for the already-existing `controlHtml` in `_appendInlineRow` which can stay as-is)
- `_buildSubSectionHeader`, `_buildSliderRow`, `_buildToggleRow` are private functions inside modal.js (not exported)
  </action>
  <verify>
    <automated>node --input-type=module --eval "
import { openSettingsModal, SETTINGS_CONTROL_IDS } from '/Users/magnus/IM Dropbox/Magnus Andersen/DOCS/code/260127 - Waveguide Generator/src/ui/settings/modal.js';
console.log('modal imports OK');
console.log('SETTINGS_CONTROL_IDS present:', typeof SETTINGS_CONTROL_IDS === 'object');
" 2>&1</automated>
  </verify>
  <done>
    - `src/ui/settings/modal.js` imports from `./viewerSettings.js` successfully
    - `_buildViewerSection()` builds three sub-sections: Orbit Controls, Camera, Input
    - `_buildSystemSection()` includes both the existing update-check row AND the new reset-all row
    - reset-all click handler calls `applyViewerSettingsToControls` and `setInvertWheelZoom` with RECOMMENDED_DEFAULTS after resetting storage
    - Existing exports (`SETTINGS_CONTROL_IDS`, `getLiveUpdateEnabled`, `getDisplayMode`, `getDownloadSimMeshEnabled`, `openSettingsModal`) are unchanged
    - `npm test` passes (no regressions to Phase 1 modal tests)
  </done>
</task>

</tasks>

<verification>
1. `node --input-type=module --eval "import { openSettingsModal } from './src/ui/settings/modal.js'"` — no error
2. `grep "settings-subsection-header" src/style.css` — found
3. `grep "reset-all-settings-btn" src/ui/settings/modal.js` — found
4. `grep "debouncedSaveViewerSettings" src/ui/settings/modal.js` — found
5. `grep "SETTINGS_CONTROL_IDS" src/ui/settings/modal.js` — found (export unchanged)
6. `grep "applyViewerSettingsToControls.*RECOMMENDED_DEFAULTS" src/ui/settings/modal.js` — found (reset-all live-apply)
7. `npm test` — all tests pass
</verification>

<success_criteria>
Settings > Viewer section shows three sub-sections with all controls. Per-section Reset buttons restore recommended values and update badges. System section has Reset All action that immediately live-applies RECOMMENDED_DEFAULTS to OrbitControls and wheel zoom direction. All changes auto-save and live-apply to OrbitControls. `npm test` passes.
</success_criteria>

<output>
After completion, create `.planning/phases/02-viewer-controls-persistence-and-reset-ux/02-03-SUMMARY.md`
</output>
