# Waveguide Generator: Technical Documentation

## 1. Overview

This project is a web application for acoustic horn design and simulation. It combines:

- Parametric horn geometry generation (OSSE/R-OSSE)
- Real-time Three.js rendering
- A canonical mesh payload contract shared by export and simulation paths
- A Python FastAPI backend for BEM job execution

Primary entry points:

- Frontend app boot: `src/main.js`
- Frontend coordinator: `src/app/App.js`
- Backend API: `server/app.py`

## 2. Runtime Architecture

### 2.1 Frontend layers

- `src/app/`
  - App orchestration (`App.js`)
  - Scene/render lifecycle (`scene.js`)
  - Config import/export adapters (`configImport.js`, `exports.js`, `mesh.js`)
- `src/ui/`
  - Parameter and simulation UI behavior
  - File operations and user feedback
- `src/geometry/`
  - Horn formulas, mesh generation, surface tags, transforms, and canonical payload assembly
- `src/export/`
  - File-format writers (MSH, GEO, CSV, STL, ABEC)
- `src/solver/`
  - Backend client and mesh payload validation on the frontend side
- `src/state.js`
  - App state, history (undo/redo), and persistence to localStorage

### 2.2 Backend layers

- `server/app.py`
  - FastAPI application
  - Request models and endpoint handlers
  - Job queue/status/result memory store
- `server/solver/`
  - BEM solver adapter and frequency-domain solve logic
  - Mesh preparation and optional Gmsh refinement
  - Directivity and supporting utilities

## 3. Core Data Flow

End-to-end flow:

1. User changes a parameter in UI.
2. `GlobalState` updates and emits `state:updated`.
3. `App` rebuilds parameter UI and requests render.
4. `src/app/scene.js` calls `buildGeometryArtifacts(...)` from `src/geometry/pipeline.js`.
5. The same canonical geometry path is reused for:
   - Viewport mesh rendering
   - Export generation
   - Simulation mesh payload
6. Simulation run in `src/ui/simulation/actions.js` requests mesh via `simulation:mesh-requested` and submits to backend.
7. Backend processes async job (`/api/solve`) and frontend polls `/api/status/{job_id}` until `/api/results/{job_id}` is ready.

## 4. Canonical Mesh Payload Contract

The frontend sends this mesh structure to backend:

```json
{
  "vertices": [0.0, 0.0, 0.0],
  "indices": [0, 1, 2],
  "surfaceTags": [2],
  "format": "msh",
  "boundaryConditions": {
    "throat": { "type": "velocity", "surfaceTag": 2, "value": 1.0 },
    "wall": { "type": "neumann", "surfaceTag": 1, "value": 0.0 },
    "mouth": { "type": "robin", "surfaceTag": 1, "impedance": "spherical" }
  },
  "metadata": {}
}
```

Implemented validation points:

- Frontend contract validation: `src/solver/index.js` (`validateCanonicalMeshPayload`)
- Backend request validation: `server/app.py` + Pydantic models
- Backend mesh integrity checks (index bounds, tag consistency): `server/solver/mesh.py`

### 4.1 Surface tag semantics

Canonical mapping used across frontend/backend:

- `1` = walls
- `2` = source
- `3` = secondary domain
- `4` = interface

Source of truth on frontend: `src/geometry/tags.js`

## 5. Geometry and Mesh Pipeline

Key files:

- `src/geometry/hornModels.js`: OSSE/R-OSSE profile math
- `src/geometry/morphing.js`: circular-to-rectangular morphing
- `src/geometry/meshBuilder.js`: triangle mesh construction and grouping
- `src/geometry/enclosure.js`: enclosure and stitching logic
- `src/geometry/pipeline.js`:
  - `buildGeometryArtifacts(...)`
  - `buildCanonicalMeshPayload(...)`

Important behavior:

- A single geometry path feeds render/export/simulation to reduce drift.
- Freestanding exports can force rear closure based on params (`shouldForceRearClosure(...)`).
- Interface/enclosure tagging is derived from mesh groups and interface offset.

## 6. Export System

Frontend export entry points live in `src/app/exports.js`.

Supported exports:

- STL: binary STL from Three.js geometry
- GEO: full Gmsh geometry + generated BEMPP starter Python script
- MSH: tagged mesh export using canonical tag rules
- ABEC: ZIP bundle with project files, mesh, GEO, starter script, and results templates
- CSV: horn profile coordinate export
- MWG config text

ABEC ZIP assembly uses `JSZip` in browser and includes simulation configuration files generated by:

- `src/export/abecProject.js`
- `src/export/bempp.js`

## 7. Backend API Contract

Base URL: `http://localhost:8000`

### `GET /health`

Returns health status and solver availability indicator.

### `POST /api/solve`

- Validates mesh shape and `surfaceTags` count against triangle count.
- Creates job ID and schedules async solve task.
- Returns `{"job_id": "..."}` on success.

### `POST /api/stop/{job_id}`

- Cancels queued/running job.

### `GET /api/status/{job_id}`

- Returns status and progress.

### `GET /api/results/{job_id}`

- Returns simulation results when status is complete.

## 8. Testing and Verification

Primary automated checks:

- Frontend/unit tests: `npm test`
- Backend tests (project Python): `cd server && ../.venv/bin/python -m unittest discover -s tests`
- NPM backend script: `npm run test:server`
- Frontend production bundle: `npm run build`

Reference/parity utilities:

- `scripts/ath-compare.js`
- `scripts/abec-compare.js`
- `scripts/gmsh-export.py`
- `scripts/validate-geo.py`

## 9. Operational Notes

- Frontend dev server is Express static hosting on port `3000` (`scripts/dev-server.js`).
- Combined start script runs frontend + backend together (`scripts/start-all.js`).
- Backend server uses FastAPI/Uvicorn on port `8000` (`server/app.py`).

## 10. Known Constraints and Risks

Current high-risk areas are tracked in `fixes.md`. As of 2026-02-08:

- ATH parity for GEO/STL/MSH across full reference set is still incomplete.
- ABEC parity requires more reference-level validation.
- End-to-end runtime simulation verification needs broader fixture coverage.

These are release-quality risks, not blockers for local development flow.

## 11. File Map (Key Files)

- Frontend boot: `src/main.js`
- App coordinator: `src/app/App.js`
- Global state: `src/state.js`
- Geometry pipeline: `src/geometry/pipeline.js`
- Surface tags: `src/geometry/tags.js`
- Export orchestration: `src/app/exports.js`
- Simulation UI actions: `src/ui/simulation/actions.js`
- Solver client: `src/solver/index.js`
- Backend API: `server/app.py`
- Backend mesh handling: `server/solver/mesh.py`
- Backend tests: `server/tests/`
